<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ToastMasters Timer</title>
  <style>
    :root {
      color-scheme: light;
      --timer-bg: rgba(255, 255, 255, 0.85);
      --timer-color: #111;
    }

    body {
      margin: 0;
      padding: 18px;
      font-family: Arial, Helvetica, sans-serif;
      color: #111;
      background: #fff;
      text-align: center;
    }

    #ui-toggle-bar {
      max-width: 1080px;
      margin: 0 auto 18px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }

    #toggleUiBtn {
      padding: 8px 14px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1px solid #0d6efd;
      background: #0d6efd;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease;
    }

    #toggleUiBtn:hover {
      background: #0b5ed7;
      transform: translateY(-1px);
    }

    #toggleUiBtn:active {
      transform: translateY(0);
    }

    #ui-version-label {
      font-weight: 600;
      font-size: 0.95rem;
    }

    #app {
      max-width: 1080px;
      margin: 0 auto;
    }

    h1 {
      margin: 12px 0;
      font-size: clamp(1.8rem, 4vw, 2.8rem);
    }

    #meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin: 12px auto 18px;
    }

    .field {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .field label {
      font-weight: 600;
    }

    .field input,
    select,
    button {
      font-size: 1rem;
      padding: 8px 10px;
    }

    #display-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      margin: 0 auto 18px;
      max-width: 980px;
    }

    #who,
    #topic {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      border: 2px solid #eee;
      padding: 12px 14px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    #timer-display {
      margin: 16px auto 24px;
      max-width: 520px;
      border-radius: 16px;
      padding: 24px;
      font-size: clamp(4rem, 14vw, 8rem);
      font-weight: 800;
      line-height: 1;
      background: var(--timer-bg);
      color: var(--timer-color);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .controls {
      margin: 0 auto 22px;
      max-width: 980px;
    }

    .time-inputs {
      margin: 12px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    .time-inputs input {
      width: 3.3em;
      text-align: right;
    }

    #grace-indicator {
      display: none;
      margin: 0 auto 16px;
      padding: 8px 18px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.95);
      color: #7a1111;
      font-weight: 700;
      letter-spacing: 0.3px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.6), 0 10px 24px rgba(0, 0, 0, 0.15);
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #grace-indicator.active {
      display: inline-flex;
      animation: graceBlink 1s ease-in-out infinite alternate;
    }

    #grace-indicator .grace-icon {
      font-size: 1.4rem;
    }

    @keyframes graceBlink {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0.55; transform: scale(0.97); }
    }

    .button-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      justify-content: space-evenly;
      align-items: center;
      margin: 14px 0 8px;
      width: 100%;
    }

    #hint {
      margin-top: 10px;
      font-size: 0.95rem;
      opacity: 0.8;
    }

    hr.section-divider {
      margin: 24px auto;
      max-width: 980px;
    }

    #log-section {
      max-width: 980px;
      margin: 0 auto 40px;
      text-align: left;
    }

    #log-section h2 {
      text-align: center;
      margin-bottom: 14px;
    }

    #log-section table {
      width: 100%;
      border-collapse: collapse;
    }

    #log-section th,
    #log-section td {
      border-bottom: 1px solid #e5e5e5;
      padding: 8px;
      text-align: left;
    }

    .credits {
      margin: 24px auto 0;
      text-align: center;
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .credits a {
      color: inherit;
      text-decoration: underline;
    }

    .within-cell {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      border-radius: 999px;
      padding: 4px 12px;
      min-width: 160px;
      justify-content: center;
    }

    .within-cell.status-under {
      background: #e0f1ff;
      color: #084c8c;
    }

    .within-cell.status-within {
      background: #d1f7d6;
      color: #125728;
    }

    .within-cell.status-over {
      background: #fcd6d6;
      color: #8a1f1f;
    }

    .within-cell .status-icon {
      font-size: 1.1rem;
    }


    .btn-icon {
      margin-right: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.05em;
    }

    .btn-label {
      display: inline-flex;
      align-items: center;
    }

    body.ui-v2 {
      font-family: "Inter", "Segoe UI", sans-serif;
      color: #212529;
      background: #f8f9fb;
      text-align: left;
      --timer-bg: #0d6efd;
      --timer-color: #fff;
    }

    body.ui-v2 #ui-toggle-bar {
      background: linear-gradient(135deg, #0d6efd, #6610f2);
      color: #fff;
      padding: 14px 24px;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 12px 24px rgba(13, 110, 253, 0.25);
    }

    body.ui-v2 #toggleUiBtn {
      background: rgba(255, 255, 255, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.45);
      color: #fff;
    }

    body.ui-v2 h1 {
      text-align: center;
      color: #0d1b3d;
      margin-bottom: 24px;
      font-weight: 700;
    }

    body.ui-v2 #meta,
    body.ui-v2 .controls,
    body.ui-v2 #log-section {
      background: #fff;
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
    }

    body.ui-v2 #display-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    body.ui-v2 #display-bar > div {
      flex: 1 1 0;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      border: 0;
      text-align: left;
      padding: 20px;
    }

    body.ui-v2 #timer-display {
      margin-top: 18px;
      margin-bottom: 32px;
      border-radius: 24px;
      box-shadow: 0 18px 48px rgba(13, 110, 253, 0.28);
    }

    body.ui-v2 .button-bar.primary-actions {
      justify-content: space-between;
      gap: 18px;
    }

    @media (max-width: 700px) {
      body { padding: 14px; }
      #ui-toggle-bar { flex-wrap: wrap; justify-content: center; }
      body.ui-v2 #display-bar { flex-direction: column; }
      #timer-display { font-size: clamp(3.5rem, 24vw, 7rem); }
    }
  </style>
</head>
<body>
  <div id="ui-toggle-bar">
    <span id="ui-version-label">UI v1 ‚Äì Classic</span>
    <button id="toggleUiBtn" type="button">Switch to Modern UI</button>
  </div>

  <div id="app">
    <h1>ToastMasters Timer</h1>

    <div id="meta">
      <div class="field">
        <label for="speakerInput">Speaker:</label>
        <input id="speakerInput" type="text" placeholder="Name" />
      </div>
      <div class="field">
        <label for="topicInput">Topic:</label>
        <input id="topicInput" type="text" placeholder="Table Topic / Speech Title" />
      </div>
    </div>

    <div id="display-bar">
      <div id="who">Speaker: <span id="speakerName">‚Äî</span></div>
      <div id="topic">Topic: <span id="topicName">‚Äî</span></div>
    </div>

    <div id="timer-display">00:00</div>
    <div id="grace-indicator" role="status" aria-live="polite" aria-hidden="true">
      <span class="grace-icon" aria-hidden="true">üïí</span>
      <span class="grace-text">30s grace period in effect</span>
    </div>

    <div class="controls">
      <select id="preset">
        <option value="TT">Table Topics (1‚Äì2 min)</option>
        <option value="EV">Evaluation (2‚Äì3 min)</option>
        <option value="SP">Speech (5‚Äì7 min)</option>
        <option value="Custom">Custom/Other</option>
      </select>

      <div class="time-inputs">
        <label>Green:</label>
        <input id="green-min" type="number" min="0" value="1" /> :
        <input id="green-sec" type="number" min="0" max="59" value="0" />
        <label>Yellow:</label>
        <input id="yellow-min" type="number" min="0" value="1" /> :
        <input id="yellow-sec" type="number" min="0" max="59" value="30" />
        <label>Red:</label>
        <input id="red-min" type="number" min="0" value="2" /> :
        <input id="red-sec" type="number" min="0" max="59" value="0" />
      </div>

          <div class="button-bar primary-actions">
        <button id="startPauseBtn">
          <span class="btn-icon" aria-hidden="true">‚ñ∂Ô∏è</span>
          <span class="btn-label">Start</span>
        </button>
        <button id="resetBtn">
          <span class="btn-icon" aria-hidden="true">‚ü≤</span>
          <span class="btn-label">Reset</span>
        </button>
        <button id="endTalkBtn" type="button">
          <span class="btn-icon" aria-hidden="true">üõë</span>
          <span class="btn-label">End Talk</span>
        </button>
        <button id="downloadCsvBtn" type="button">
          <span class="btn-icon" aria-hidden="true">‚¨áÔ∏è</span>
          <span class="btn-label">Download CSV</span>
        </button>
      </div>

      <div id="hint">Press <strong>Spacebar</strong> to Start/Pause. (Ignored while typing in inputs.)</div>

      <div class="field" style="justify-content:center; gap:12px; margin-top:12px;">
        <span style="font-weight:600;">Cue sound:</span>
        <span>Built-in sound</span>
        <button id="testSoundBtn" type="button">
          <span class="btn-icon" aria-hidden="true">üîä</span>
          <span class="btn-label">Test Sound</span>
        </button>
      </div>
    </div>

    <hr class="section-divider" />

    <div id="log-section">
      <h2>Timer Log</h2>
      <div style="overflow-x:auto;">
        <table id="logTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Topic</th>
              <th>Total Time</th>
              <th>Time Status</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>

    <footer class="credits">Created by <a href="https://www.linkedin.com/in/tusharvartak/" target="_blank" rel="noopener noreferrer">Tushar Vartak</a></footer>
  </div>

  <script>

    const timerDisplay = document.getElementById('timer-display');
    const presetSelect = document.getElementById('preset');
    const greenMinInput = document.getElementById('green-min');
    const greenSecInput = document.getElementById('green-sec');
    const yellowMinInput = document.getElementById('yellow-min');
    const yellowSecInput = document.getElementById('yellow-sec');
    const redMinInput = document.getElementById('red-min');
    const redSecInput = document.getElementById('red-sec');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const endTalkBtn = document.getElementById('endTalkBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const speakerInput = document.getElementById('speakerInput');
    const topicInput = document.getElementById('topicInput');
    const speakerName = document.getElementById('speakerName');
    const topicName = document.getElementById('topicName');
    const testSoundBtn = document.getElementById('testSoundBtn');
    const logBody = document.getElementById('logBody');
    const toggleUiBtn = document.getElementById('toggleUiBtn');
    const uiVersionLabel = document.getElementById('ui-version-label');
    const metaPanel = document.getElementById('meta');
    const displayBar = document.getElementById('display-bar');
    const whoDisplay = document.getElementById('who');
    const topicDisplay = document.getElementById('topic');
    const controlsPanel = document.querySelector('.controls');
    const buttonBars = Array.from(document.querySelectorAll('.button-bar'));
    const logSection = document.getElementById('log-section');
    const startPauseLabel = startPauseBtn.querySelector('.btn-label');
    const graceIndicator = document.getElementById('grace-indicator');

    const numericInputs = [
      greenMinInput,
      greenSecInput,
      yellowMinInput,
      yellowSecInput,
      redMinInput,
      redSecInput
    ];

    const bootstrapFormControls = [
      speakerInput,
      topicInput,
      ...numericInputs
    ].filter(Boolean);

    const bootstrapButtonConfig = [
      { element: startPauseBtn, classes: ['btn', 'btn-success'] },
      { element: resetBtn, classes: ['btn', 'btn-outline-secondary'] },
      { element: endTalkBtn, classes: ['btn', 'btn-warning'] },
      { element: downloadCsvBtn, classes: ['btn', 'btn-info', 'text-white'] },
      { element: testSoundBtn, classes: ['btn', 'btn-outline-primary'] }
    ];

    const bootstrapClassEntries = [
      { elements: [metaPanel], classes: ['card', 'shadow-sm', 'p-4', 'mb-4'] },
      { elements: [displayBar], classes: ['row', 'g-3', 'mb-3', 'align-items-stretch'] },
      { elements: [whoDisplay, topicDisplay], classes: ['col', 'card', 'shadow-sm', 'p-4', 'text-start'] },
      { elements: [controlsPanel], classes: ['card', 'shadow-sm', 'p-4', 'mb-4'] },
      { elements: buttonBars, classes: ['d-flex', 'flex-wrap', 'gap-3', 'justify-content-start'] },
      { elements: [logSection], classes: ['card', 'shadow-sm', 'p-4'] }
    ];

    const bootstrapHref = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css';
    let bootstrapLinkEl = null;

    const logRecords = [];
    const GRACE_SECONDS = 30;
    const cueAudioUrl = 'ding.mp3';
    let lastCue = 'none';
    let lastGraceState = null;

    function playCue() {
      if (!cueAudioUrl) return;
      const audio = new Audio(cueAudioUrl);
      audio.play().catch(() => {});
    }

    function playDoubleCue() {
      playCue();
      setTimeout(playCue, 400);
    }

    let elapsedSeconds = 0;
    let timerInterval = null;
    let isRunning = false;

    const presets = {
      TT: { green: 60, yellow: 90, red: 120 },
      EV: { green: 120, yellow: 150, red: 180 },
      SP: { green: 300, yellow: 360, red: 420 }
    };

    function applyPreset(key) {
      const preset = presets[key];
      if (!preset) return;
      greenMinInput.value = Math.floor(preset.green / 60);
      greenSecInput.value = preset.green % 60;
      yellowMinInput.value = Math.floor(preset.yellow / 60);
      yellowSecInput.value = preset.yellow % 60;
      redMinInput.value = Math.floor(preset.red / 60);
      redSecInput.value = preset.red % 60;
    }

    function setInputsDisabled(state) {
      numericInputs.forEach((input) => { if (input) input.disabled = state; });
    }

    applyPreset(presetSelect.value);
    setInputsDisabled(true);

    presetSelect.addEventListener('change', () => {
      if (presetSelect.value !== 'Custom') {
        applyPreset(presetSelect.value);
        setInputsDisabled(true);
      } else {
        setInputsDisabled(false);
      }
    });

    function formatTime(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const minStr = minutes < 10 ? `0${minutes}` : `${minutes}`;
      const secStr = seconds < 10 ? `0${seconds}` : `${seconds}`;
      return `${minStr}:${secStr}`;
    }

    function thresholds() {
      return {
        green: (parseInt(greenMinInput.value || '0', 10) * 60) + (parseInt(greenSecInput.value || '0', 10)),
        yellow: (parseInt(yellowMinInput.value || '0', 10) * 60) + (parseInt(yellowSecInput.value || '0', 10)),
        red: (parseInt(redMinInput.value || '0', 10) * 60) + (parseInt(redSecInput.value || '0', 10))
      };
    }

    function applyVisualCue(cue) {
      switch (cue) {
        case 'green':
          document.body.style.backgroundColor = '#c8f7c5';
          timerDisplay.style.backgroundColor = '#198754';
          timerDisplay.style.color = '#fff';
          break;
        case 'yellow':
          document.body.style.backgroundColor = '#ffec99';
          timerDisplay.style.backgroundColor = '#ffc107';
          timerDisplay.style.color = '#212529';
          break;
        case 'red':
          document.body.style.backgroundColor = '#ff4d4f';
          timerDisplay.style.backgroundColor = '#dc3545';
          timerDisplay.style.color = '#fff';
          break;
        default:
          document.body.style.backgroundColor = document.body.classList.contains('ui-v2') ? '' : '#fff';
          timerDisplay.style.backgroundColor = 'var(--timer-bg)';
          timerDisplay.style.color = 'var(--timer-color)';
      }
    }

    function setGraceIndicator(active) {
      if (!graceIndicator) return;
      if (lastGraceState === active) return;
      lastGraceState = active;
      if (active) {
        graceIndicator.classList.add('active');
        graceIndicator.setAttribute('aria-hidden', 'false');
      } else {
        graceIndicator.classList.remove('active');
        graceIndicator.setAttribute('aria-hidden', 'true');
      }
    }

    function updateBackground() {
      const t = thresholds();
      const graceLimit = t.red > 0 ? t.red + GRACE_SECONDS : null;
      const withinGrace = graceLimit !== null && elapsedSeconds >= t.red && elapsedSeconds <= graceLimit;
      let cue = 'none';

      if (elapsedSeconds >= t.red && t.red > 0) {
        cue = 'red';
      } else if (elapsedSeconds >= t.yellow && t.yellow > 0) {
        cue = 'yellow';
      } else if (elapsedSeconds >= t.green && t.green > 0) {
        cue = 'green';
      }

      applyVisualCue(cue);
      setGraceIndicator(withinGrace);

      if (cue !== 'none' && cue !== lastCue) {
        if (cue === 'red') {
          playDoubleCue();
        } else {
          playCue();
        }
      }

      lastCue = cue;
    }

    function updateTimer() {
      elapsedSeconds += 1;
      timerDisplay.textContent = formatTime(elapsedSeconds);
      updateBackground();
    }

    function evaluateStatus(totalSeconds) {
      const t = thresholds();
      const red = t.red;
      const graceLimit = red > 0 ? red + GRACE_SECONDS : null;

      if (totalSeconds < t.green) {
        return { label: 'Under Time', className: 'status-under', icon: '‚è±Ô∏è' };
      }

      if (red > 0 && totalSeconds > red) {
        if (graceLimit !== null && totalSeconds <= graceLimit) {
          return { label: 'Within Time', className: 'status-within', icon: 'üëç' };
        }
        return { label: 'Over Time', className: 'status-over', icon: 'üëé' };
      }

      return { label: 'Within Time', className: 'status-within', icon: 'üëç' };
    }

    function appendLogRow(rec) {
      const tr = document.createElement('tr');

      const nameCell = document.createElement('td');
      nameCell.textContent = rec.name;
      tr.appendChild(nameCell);

      const topicCell = document.createElement('td');
      topicCell.textContent = rec.topic;
      tr.appendChild(topicCell);

      const timeCell = document.createElement('td');
      timeCell.textContent = rec.totalTime;
      tr.appendChild(timeCell);

      const statusCell = document.createElement('td');
      const wrapper = document.createElement('span');
      wrapper.className = `within-cell ${rec.statusClass}`;
      wrapper.innerHTML = `<span class="status-icon" aria-hidden="true">${rec.statusIcon}</span><span>${rec.statusLabel}</span>`;
      wrapper.setAttribute('role', 'text');
      statusCell.appendChild(wrapper);
      tr.appendChild(statusCell);

      logBody.appendChild(tr);
    }

    function csvEscape(val) {
      const s = String(val ?? '');
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }

    function buildCsv() {
      const header = ['Name', 'Topic', 'TotalTime', 'TimeStatus'];
      const lines = [header.join(',')];
      for (const record of logRecords) {
        lines.push([
          csvEscape(record.name),
          csvEscape(record.topic),
          csvEscape(record.totalTime),
          csvEscape(record.status)
        ].join(','));
      }
      return lines.join('\n');
    }

    function toggleBootstrapDecorations(enable) {
      const method = enable ? 'add' : 'remove';
      bootstrapClassEntries.forEach(({ elements, classes }) => {
        const targets = Array.isArray(elements) ? elements : [elements];
        targets.forEach((node) => {
          if (!node) return;
          node.classList[method](...classes);
        });
      });
      bootstrapFormControls.forEach((control) => {
        control.classList[method]('form-control');
      });
      bootstrapButtonConfig.forEach(({ element, classes }) => {
        if (!element) return;
        element.classList[method](...classes);
      });
      presetSelect.classList[method]('form-select');
    }

    function loadBootstrapStylesheet() {
      if (bootstrapLinkEl) return;
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = bootstrapHref;
      link.crossOrigin = 'anonymous';
      link.referrerPolicy = 'no-referrer';
      document.head.appendChild(link);
      bootstrapLinkEl = link;
    }

    function unloadBootstrapStylesheet() {
      if (!bootstrapLinkEl) return;
      bootstrapLinkEl.remove();
      bootstrapLinkEl = null;
    }

    function setUiVersion(version) {
      const isV2 = version === 'v2';
      if (isV2) {
        loadBootstrapStylesheet();
        document.body.classList.add('ui-v2');
      } else {
        document.body.classList.remove('ui-v2');
        unloadBootstrapStylesheet();
      }
      toggleBootstrapDecorations(isV2);
      if (toggleUiBtn) toggleUiBtn.textContent = isV2 ? 'Switch to Classic UI' : 'Switch to Modern UI';
      if (uiVersionLabel) uiVersionLabel.textContent = isV2 ? 'UI v2 ‚Äì Modern' : 'UI v1 ‚Äì Classic';
      applyVisualCue('none');
      if (!isRunning) {
        setGraceIndicator(false);
      }
      lastCue = 'none';
    }

    toggleUiBtn.addEventListener('click', () => {
      setUiVersion(document.body.classList.contains('ui-v2') ? 'v1' : 'v2');
    });

    function toggleStartPause() {
      if (!isRunning) {
        isRunning = true;
        if (startPauseLabel) startPauseLabel.textContent = 'Pause';
        if (elapsedSeconds === 0) {
          applyVisualCue('none');
          lastCue = 'none';
          setGraceIndicator(false);
        }
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        isRunning = false;
        if (startPauseLabel) startPauseLabel.textContent = 'Resume';
        clearInterval(timerInterval);
      }
    }

    startPauseBtn.addEventListener('click', toggleStartPause);

    resetBtn.addEventListener('click', () => {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      isRunning = false;
      elapsedSeconds = 0;
      timerDisplay.textContent = '00:00';
      applyVisualCue('none');
      lastCue = 'none';
      setGraceIndicator(false);
      if (startPauseLabel) startPauseLabel.textContent = 'Start';
      speakerInput.value = '';
      topicInput.value = '';
      updateSpeaker();
      updateTopic();
    });

    endTalkBtn.addEventListener('click', () => {
      const name = (speakerInput.value.trim() || speakerName.textContent || '').trim();
      const topic = (topicInput.value.trim() || topicName.textContent || '').trim();
      const totalTime = formatTime(elapsedSeconds);
      const status = evaluateStatus(elapsedSeconds);

      const record = { name, topic, totalTime, status: status.label };
      logRecords.push(record);
      appendLogRow({ ...record, statusLabel: status.label, statusClass: status.className, statusIcon: status.icon });

      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      isRunning = false;
      elapsedSeconds = 0;
      timerDisplay.textContent = '00:00';
      applyVisualCue('none');
      lastCue = 'none';
      setGraceIndicator(false);
      if (startPauseLabel) startPauseLabel.textContent = 'Start';
      speakerInput.value = '';
      topicInput.value = '';
      updateSpeaker();
      updateTopic();
      document.getElementById('log-section')?.scrollIntoView({ behavior: 'smooth' });
    });

    downloadCsvBtn.addEventListener('click', () => {
      const csv = buildCsv();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement('a');
      const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
      anchor.href = url;
      anchor.download = `toastmasters_log_${timestamp}.csv`;
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
      URL.revokeObjectURL(url);
    });

    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space') {
        const tag = document.activeElement?.tagName;
        if (tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT') {
          event.preventDefault();
          toggleStartPause();
        }
      }
    });

    function updateSpeaker() {
      const value = speakerInput.value.trim();
      speakerName.textContent = value ? value : '‚Äî';
    }

    function updateTopic() {
      const value = topicInput.value.trim();
      topicName.textContent = value ? value : '‚Äî';
    }

    speakerInput.addEventListener('input', updateSpeaker);
    topicInput.addEventListener('input', updateTopic);


    testSoundBtn?.addEventListener('click', playCue);


    updateSpeaker();
    updateTopic();
    setUiVersion('v1');
    applyVisualCue('none');
    setGraceIndicator(false);
  </script>
</body>
</html>
