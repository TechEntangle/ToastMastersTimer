<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; connect-src 'self' https://geaqvvbkwgfoxiakzums.supabase.co wss://geaqvvbkwgfoxiakzums.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data:;">
  <title>ToastMasters Timer</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" crossorigin="anonymous">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <style>
    :root {
      color-scheme: light;
      --timer-bg: #ffffff;
      --timer-color: #111111;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      background: #f5f7fb;
      color: #212529;
    }

    #app {
      max-width: 1100px;
    }

    header .badge {
      font-size: 0.85rem;
    }

    #display-bar .info-card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
      height: 100%;
    }

    #display-bar .info-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
      color: #6c757d;
      margin-bottom: 0.35rem;
      font-weight: 600;
    }

    #display-bar .info-value {
      font-size: 1.35rem;
      font-weight: 600;
      color: #1f2937;
    }

    .timer-shell {
      border: 0;
      border-radius: 1.5rem;
      background: #ffffff;
      box-shadow: 0 26px 48px rgba(15, 23, 42, 0.15);
    }

    .timer-shell .card-body {
      padding: 2.75rem 1.5rem;
    }

    #timer-display {
      margin: 0 auto;
      font-size: clamp(3.5rem, 14vw, 7rem);
      font-weight: 700;
      letter-spacing: 1px;
      padding: 2.4rem 1.5rem;
      border-radius: 1.25rem;
      background: var(--timer-bg);
      color: var(--timer-color);
      box-shadow: 0 18px 42px rgba(15, 23, 42, 0.18);
    }

    #grace-indicator {
      display: none;
      margin: 1.5rem auto 0;
      padding: 0.65rem 1.5rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.96);
      color: #7a1111;
      font-weight: 700;
      letter-spacing: 0.3px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.6), 0 18px 32px rgba(15, 23, 42, 0.18);
      align-items: center;
      gap: 10px;
    }

    #grace-indicator.active {
      display: inline-flex;
      animation: graceBlink 1s ease-in-out infinite alternate;
    }

    #grace-indicator .grace-icon {
      font-size: 1.4rem;
    }

    @keyframes graceBlink {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0.55; transform: scale(0.97); }
    }

    #running-hint {
      display: none;
      margin: 0.75rem auto 0;
      padding: 0.6rem 1.4rem;
      background: rgba(33, 37, 41, 0.9);
      color: #fff;
      font-weight: 600;
      border-radius: 999px;
      max-width: 440px;
      text-align: center;
      letter-spacing: 0.2px;
    }

    #mini-control-bar {
      display: none;
      margin: 1.5rem auto 0;
      padding: 0.75rem 1.5rem;
      background: rgba(33, 37, 41, 0.92);
      border-radius: 999px;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.3);
    }

    #mini-control-bar.active {
      display: inline-flex;
    }

    .mini-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: #fff;
      padding: 0.6rem 1rem;
      border-radius: 12px;
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 48px;
      min-height: 48px;
    }

    .mini-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .mini-btn:active {
      transform: translateY(0);
    }

    .mini-btn[title] {
      position: relative;
    }

    .time-input-group input {
      width: 4.2rem;
      text-align: right;
    }

    .time-input-group .separator {
      font-weight: 600;
      color: #495057;
    }

    .button-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    #log-section table {
      width: 100%;
      border-collapse: collapse;
    }

    #log-section th,
    #log-section td {
      border-bottom: 1px solid #eceff4;
      padding: 0.75rem;
      text-align: left;
    }

    #log-section th {
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.78rem;
      color: #6c757d;
      background: #f1f4fb;
    }

    #log-section tbody tr:last-child td {
      border-bottom: 0;
    }

    .within-cell {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      border-radius: 999px;
      padding: 4px 12px;
      min-width: 160px;
      justify-content: center;
    }

    .within-cell.status-under {
      background: #e0f1ff;
      color: #084c8c;
    }

    .within-cell.status-within {
      background: #d1f7d6;
      color: #125728;
    }

    .within-cell.status-over {
      background: #fcd6d6;
      color: #8a1f1f;
    }

    .within-cell .status-icon {
      font-size: 1.1rem;
    }

    .btn-icon {
      margin-right: 0.35rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.05em;
    }

    .btn-label {
      display: inline-flex;
      align-items: center;
    }

    .credits {
      margin: 3rem auto 0;
      text-align: center;
      font-size: 0.95rem;
      color: #6c757d;
    }

    .credits a {
      color: inherit;
      text-decoration: underline;
    }

    #meta.locked .form-control {
      display: none;
    }

    #meta.locked .form-label {
      display: none;
    }

    .meta-card-display {
      display: none;
      padding: 1rem 1.25rem;
      background: #f8f9fa;
      border-left: 4px solid #0d6efd;
      border-radius: 8px;
    }

    #meta.locked .meta-card-display {
      display: block;
    }

    .meta-card-label {
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.7rem;
      color: #6c757d;
      margin-bottom: 0.35rem;
      font-weight: 600;
    }

    .meta-card-value {
      font-size: 1.15rem;
      font-weight: 600;
      color: #212529;
      word-break: break-word;
    }

    .meta-lock-indicator {
      display: none;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #dee2e6;
    }

    #meta.locked .meta-lock-indicator {
      display: flex;
    }

    @media (max-width: 576px) {
      .time-input-group input {
        width: 3.4rem;
      }
      #timer-display {
        font-size: clamp(3.25rem, 22vw, 6rem);
        padding: 2rem 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container-lg py-4">
    <header class="mb-4">
      <div class="row align-items-center g-3">
        <div class="col-md-8 text-center text-md-start">
          <h1 class="fw-semibold mb-1">ToastMasters Timer</h1>
          <p class="text-muted mb-0">Track speeches, keep pace, and celebrate great delivery.</p>
        </div>
        <div class="col-md-4 text-center text-md-end">
          <span class="badge bg-primary-subtle text-primary-emphasis px-3 py-2 rounded-pill fw-semibold">Session ID: <span id="sessionIdBadge">‚Äî</span></span>
        </div>
      </div>
    </header>

    <div id="display-bar" class="row g-3 mb-4" style="display:none;">
      <div class="col-md-6">
        <div class="info-card h-100">
          <div class="info-label">Speaker</div>
          <div class="info-value"><span id="speakerName">‚Äî</span></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-card h-100">
          <div class="info-label">Topic</div>
          <div class="info-value"><span id="topicName">‚Äî</span></div>
        </div>
      </div>
    </div>

    <div class="card timer-shell border-0 mb-4" style="display:none;">
      <div class="card-body text-center">
        <div id="timer-display">00:00</div>
        <div id="grace-indicator" role="status" aria-live="polite" aria-hidden="true">
          <span class="grace-icon" aria-hidden="true">üïí</span>
          <span class="grace-text">30s grace period in effect</span>
        </div>
        <div id="mini-control-bar" role="toolbar" aria-label="Timer controls">
          <button type="button" class="mini-btn" id="miniPauseBtn" title="Pause" aria-label="Pause timer">‚è∏Ô∏è</button>
          <button type="button" class="mini-btn" id="miniEndTalkBtn" title="End Talk" aria-label="End talk">üõë</button>
          <button type="button" class="mini-btn" id="miniDingBtn" title="Ding Sound" aria-label="Play ding sound">üîä</button>
        </div>
        <div id="running-hint" aria-live="polite"></div>
      </div>
    </div>

    <div id="meta" class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="speakerInput" class="form-label">Speaker</label>
            <input id="speakerInput" type="text" class="form-control" placeholder="Name" />
            <div class="meta-card-display">
              <div class="meta-card-label">Speaker</div>
              <div class="meta-card-value" id="speakerCardValue">‚Äî</div>
            </div>
          </div>
          <div class="col-md-6">
            <label for="topicInput" class="form-label">Topic</label>
            <input id="topicInput" type="text" class="form-control" placeholder="Table Topic / Speech Title" />
            <div class="meta-card-display">
              <div class="meta-card-label">Topic</div>
              <div class="meta-card-value" id="topicCardValue">‚Äî</div>
            </div>
          </div>
        </div>
        <div class="meta-lock-indicator">
          <span>üîí</span>
          <span>Fields locked during session ‚Äî Reset or End Talk to edit</span>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4 controls">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-lg-3 col-md-4">
            <label for="preset" class="form-label">Timing preset</label>
            <select id="preset" class="form-select">
              <option value="TT">Table Topics (1‚Äì2 min)</option>
              <option value="EV">Evaluation (2‚Äì3 min)</option>
              <option value="SP">Speech (5‚Äì7 min)</option>
              <option value="Custom">Custom/Other</option>
            </select>
          </div>
          <div class="col-lg-9 col-md-8">
            <label class="form-label d-block">Custom thresholds (mm:ss)</label>
            <div class="row g-3">
              <div class="col-sm-4">
                <label class="form-label small text-muted" for="green-min">Green</label>
                <div class="d-flex align-items-center gap-2 time-input-group">
                  <input id="green-min" type="number" min="0" value="1" class="form-control text-end" />
                  <span class="separator">:</span>
                  <input id="green-sec" type="number" min="0" max="59" value="0" class="form-control text-end" />
                </div>
              </div>
              <div class="col-sm-4">
                <label class="form-label small text-muted" for="yellow-min">Yellow</label>
                <div class="d-flex align-items-center gap-2 time-input-group">
                  <input id="yellow-min" type="number" min="0" value="1" class="form-control text-end" />
                  <span class="separator">:</span>
                  <input id="yellow-sec" type="number" min="0" max="59" value="30" class="form-control text-end" />
                </div>
              </div>
              <div class="col-sm-4">
                <label class="form-label small text-muted" for="red-min">Red</label>
                <div class="d-flex align-items-center gap-2 time-input-group">
                  <input id="red-min" type="number" min="0" value="2" class="form-control text-end" />
                  <span class="separator">:</span>
                  <input id="red-sec" type="number" min="0" max="59" value="0" class="form-control text-end" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-3 justify-content-center mt-4 pt-3 border-top">
          <button id="startPauseBtn" type="button" class="btn btn-success px-4">
            <span class="btn-icon" aria-hidden="true">‚ñ∂Ô∏è</span>
            <span class="btn-label">Start</span>
          </button>
          <button id="resetBtn" type="button" class="btn btn-outline-secondary">
            <span class="btn-icon" aria-hidden="true">‚ü≤</span>
            <span class="btn-label">Reset</span>
          </button>
          <button id="endTalkBtn" type="button" class="btn btn-warning text-white">
            <span class="btn-icon" aria-hidden="true">üõë</span>
            <span class="btn-label">End Talk</span>
          </button>
          <button id="downloadCsvBtn" type="button" class="btn btn-outline-info">
            <span class="btn-icon" aria-hidden="true">‚¨áÔ∏è</span>
            <span class="btn-label">Download CSV</span>
          </button>
          <button id="testSoundBtn" type="button" class="btn btn-outline-primary">
            <span class="btn-icon" aria-hidden="true">üîä</span>
            <span class="btn-label">Test Sound</span>
          </button>
          <button id="ratingsDashboardBtn" type="button" class="btn btn-dark" disabled style="display:none;">
            <span class="btn-icon" aria-hidden="true">üìä</span>
            <span class="btn-label">Ratings Dashboard</span>
          </button>
        </div>
      </div>
    </div>

    <section id="log-section" class="card shadow-sm mb-5" style="display:none;">
      <div class="card-body">
        <h2 class="h4 text-center mb-3">Timer Log</h2>
        <div class="table-responsive">
          <table id="logTable" class="table align-middle">
            <thead>
              <tr>
                <th>Name</th>
                <th>Topic</th>
                <th>Total Time</th>
                <th>Time Status</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
<script>

    const timerDisplay = document.getElementById('timer-display');
    const presetSelect = document.getElementById('preset');
    const greenMinInput = document.getElementById('green-min');
    const greenSecInput = document.getElementById('green-sec');
    const yellowMinInput = document.getElementById('yellow-min');
    const yellowSecInput = document.getElementById('yellow-sec');
    const redMinInput = document.getElementById('red-min');
    const redSecInput = document.getElementById('red-sec');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const endTalkBtn = document.getElementById('endTalkBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const speakerInput = document.getElementById('speakerInput');
    const topicInput = document.getElementById('topicInput');
    const speakerName = document.getElementById('speakerName');
    const topicName = document.getElementById('topicName');
    const testSoundBtn = document.getElementById('testSoundBtn');
    const logBody = document.getElementById('logBody');
    const metaPanel = document.getElementById('meta');
    const controlsPanel = document.querySelector('.controls');
    const logSection = document.getElementById('log-section');
    const speakerCardValue = document.getElementById('speakerCardValue');
    const topicCardValue = document.getElementById('topicCardValue');
    const startPauseLabel = startPauseBtn.querySelector('.btn-label');
    const graceIndicator = document.getElementById('grace-indicator');
    const runningHint = document.getElementById('running-hint');
    const ratingsDashboardBtn = document.getElementById('ratingsDashboardBtn');
    const sessionIdBadge = document.getElementById('sessionIdBadge');
    const miniControlBar = document.getElementById('mini-control-bar');
    const miniPauseBtn = document.getElementById('miniPauseBtn');
    const miniEndTalkBtn = document.getElementById('miniEndTalkBtn');
    const miniDingBtn = document.getElementById('miniDingBtn');

    const supabaseConfig = window.tmSupabaseConfig || {};
    const supabase = (window.supabase && supabaseConfig.url && supabaseConfig.anonKey)
      ? window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey)
      : null;
    if (!supabase) {
      console.warn('Supabase client unavailable; cross-device sync will be disabled.');
    }

    let supabaseSessionInitRequested = false;

    const numericInputs = [
      greenMinInput,
      greenSecInput,
      yellowMinInput,
      yellowSecInput,
      redMinInput,
      redSecInput
    ];

    const logRecords = [];
    updateLogVisibility();
    const GRACE_SECONDS = 30;
    const RATINGS_SESSION_STORAGE_KEY = 'tmTimer.ratings.sessionId';
    const RATINGS_SNAPSHOT_STORAGE_KEY = 'tmTimer.ratings.snapshot';
    const cueAudioUrl = 'ding.mp3';
    const cueAudioTemplate = cueAudioUrl ? new Audio(cueAudioUrl) : null;
    if (cueAudioTemplate) {
      cueAudioTemplate.preload = 'auto';
      try { cueAudioTemplate.load(); } catch (err) { /* no-op */ }
    }
    let ratingsSessionId = null;
    let lastCue = 'none';
    let lastGraceState = null;

    function playCue() {
      if (!cueAudioTemplate) return;
      const audio = cueAudioTemplate.cloneNode(true);
      audio.play().catch(() => {});
    }

    function playDoubleCue() {
      playCue();
      setTimeout(playCue, 400);
    }

    let elapsedSeconds = 0;
    let timerInterval = null;
    let isRunning = false;

    const presets = {
      TT: { green: 60, yellow: 90, red: 120 },
      EV: { green: 120, yellow: 150, red: 180 },
      SP: { green: 300, yellow: 360, red: 420 }
    };

    function applyPreset(key) {
      const preset = presets[key];
      if (!preset) return;
      greenMinInput.value = Math.floor(preset.green / 60);
      greenSecInput.value = preset.green % 60;
      yellowMinInput.value = Math.floor(preset.yellow / 60);
      yellowSecInput.value = preset.yellow % 60;
      redMinInput.value = Math.floor(preset.red / 60);
      redSecInput.value = preset.red % 60;
    }

    function setInputsDisabled(state) {
      numericInputs.forEach((input) => { if (input) input.disabled = state; });
    }

        const displayBar = document.getElementById('display-bar');
    const timerShell = document.querySelector('#app .timer-shell');

    function setMetaHidden(shouldHide) {
      if (!metaPanel) return;
      metaPanel.style.display = shouldHide ? 'none' : '';
    }

    function setMetaLocked(locked) {
      if (!metaPanel) return;
      if (locked) {
        metaPanel.classList.add('locked');
        updateMetaCardValues();
      } else {
        metaPanel.classList.remove('locked');
      }
    }

    function updateMetaCardValues() {
      if (speakerCardValue) {
        const value = speakerInput.value.trim();
        speakerCardValue.textContent = value || '‚Äî';
      }
      if (topicCardValue) {
        const value = topicInput.value.trim();
        topicCardValue.textContent = value || '‚Äî';
      }
    }

    function setControlsHidden(shouldHide) {
      if (!controlsPanel) return;
      controlsPanel.style.display = shouldHide ? 'none' : '';
    }

    function setRunningHint(shouldShow) {
      if (!runningHint) return;
      if (shouldShow) {
        runningHint.style.display = 'block';
        runningHint.textContent = 'Press Spacebar to pause and show control buttons. Press "B" for ding sound.';
      } else {
        runningHint.style.display = 'none';
        runningHint.textContent = '';
      }
    }

    function setMiniControlBar(shouldShow) {
      if (!miniControlBar) return;
      if (shouldShow) {
        miniControlBar.classList.add('active');
      } else {
        miniControlBar.classList.remove('active');
      }
    }

    function setDisplayHidden(shouldHide) {
      if (displayBar) displayBar.style.display = shouldHide ? 'none' : '';
      if (timerShell) timerShell.style.display = shouldHide ? 'none' : '';
    }

    function updateLogVisibility() {
      if (!logSection) return;
      logSection.style.display = logRecords.length ? '' : 'none';
    }

    function updateSessionBadge() {
      if (!sessionIdBadge) return;
      sessionIdBadge.textContent = ratingsSessionId || '‚Äî';
    }

    function ensureSupabaseSessionInitialized(sessionId) {
      if (!supabase || !sessionId || supabaseSessionInitRequested) return;
      supabaseSessionInitRequested = true;
      (async () => {
        try {
          const nowIso = new Date().toISOString();
          await supabase.from('sessions').upsert({
            session_id: sessionId,
            created_at: nowIso,
            updated_at: nowIso,
            roster_size: 0
          }, { onConflict: 'session_id' });
        } catch (err) {
          console.warn('Unable to initialize Supabase session metadata', err);
        }
      })();
    }

    async function syncRosterToSupabase(snapshot) {
      if (!supabase || !snapshot) return;
      try {
        await supabase.from('sessions').upsert({
          session_id: snapshot.sessionId,
          updated_at: snapshot.updatedAt,
          roster_size: snapshot.roster.length
        }, { onConflict: 'session_id' });

        const { error: clearError } = await supabase
          .from('speakers')
          .delete()
          .eq('session_id', snapshot.sessionId);
        if (clearError) throw clearError;

        if (snapshot.roster.length) {
          const rows = snapshot.roster.map((entry, order) => ({
            session_id: snapshot.sessionId,
            speaker_id: entry.id,
            name: entry.name,
            topic: entry.topic,
            total_time: entry.totalTime,
            status: entry.status,
            order_index: order
          }));
          const { error: upsertError } = await supabase.from('speakers').upsert(rows);
          if (upsertError) throw upsertError;
        }
      } catch (err) {
        console.warn('Unable to sync roster to Supabase', err);
      } finally {
        console.log('[timer] synced roster to Supabase', snapshot ? snapshot.sessionId : null);
      }
    }

    function ensureRatingsSessionId() {
      if (ratingsSessionId) {
        updateSessionBadge();
        return ratingsSessionId;
      }
      let restored = null;
      try {
        restored = sessionStorage.getItem(RATINGS_SESSION_STORAGE_KEY);
      } catch (err) {
        console.warn('Unable to read ratings session id', err);
      }
      if (restored) {
        ratingsSessionId = restored;
        ensureSupabaseSessionInitialized(ratingsSessionId);
        updateSessionBadge();
        return ratingsSessionId;
      }
      const generated = `tm-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
      ratingsSessionId = generated;
      try {
        sessionStorage.setItem(RATINGS_SESSION_STORAGE_KEY, ratingsSessionId);
      } catch (err) {
        console.warn('Unable to persist ratings session id', err);
      }
      ensureSupabaseSessionInitialized(ratingsSessionId);
      updateSessionBadge();
      return ratingsSessionId;
    }

    function generateSpeakerId() {
      return `sp-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 6)}`;
    }

    function buildRosterSnapshot() {
      const withinTime = [];
      logRecords.forEach((record, index) => {
        if (record.status !== 'Within Time') return;
        withinTime.push({
          id: record.id || `sp-${index + 1}`,
          name: record.name || `Speaker ${index + 1}`,
          topic: record.topic || '',
          totalTime: record.totalTime,
          status: record.status
        });
      });
      return withinTime;
    }

    async function persistRatingsSnapshot() {
      const sessionId = ensureRatingsSessionId();
      const snapshot = {
        sessionId,
        updatedAt: new Date().toISOString(),
        roster: buildRosterSnapshot()
      };
      try {
        localStorage.setItem(RATINGS_SNAPSHOT_STORAGE_KEY, JSON.stringify(snapshot));
      } catch (err) {
        console.warn('Unable to save ratings snapshot', err);
      }
      updateRatingsControls();
      await syncRosterToSupabase(snapshot);
      return snapshot;
    }

    function updateRatingsControls() {
      if (!ratingsDashboardBtn) return;
      const hasRoster = buildRosterSnapshot().length > 0;
      ratingsDashboardBtn.disabled = !hasRoster;
      ratingsDashboardBtn.setAttribute('aria-disabled', hasRoster ? 'false' : 'true');
      ratingsDashboardBtn.style.display = hasRoster ? '' : 'none';
    }

    applyPreset(presetSelect.value);
    setInputsDisabled(true);

    presetSelect.addEventListener('change', () => {
      if (presetSelect.value !== 'Custom') {
        applyPreset(presetSelect.value);
        setInputsDisabled(true);
      } else {
        setInputsDisabled(false);
      }
    });

    function formatTime(totalSeconds) {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const minStr = minutes < 10 ? `0${minutes}` : `${minutes}`;
      const secStr = seconds < 10 ? `0${seconds}` : `${seconds}`;
      return `${minStr}:${secStr}`;
    }

    function thresholds() {
      return {
        green: (parseInt(greenMinInput.value || '0', 10) * 60) + (parseInt(greenSecInput.value || '0', 10)),
        yellow: (parseInt(yellowMinInput.value || '0', 10) * 60) + (parseInt(yellowSecInput.value || '0', 10)),
        red: (parseInt(redMinInput.value || '0', 10) * 60) + (parseInt(redSecInput.value || '0', 10))
      };
    }

    function applyVisualCue(cue) {
      switch (cue) {
        case 'green':
          document.body.style.backgroundColor = '#c8f7c5';
          timerDisplay.style.backgroundColor = '#198754';
          timerDisplay.style.color = '#fff';
          break;
        case 'yellow':
          document.body.style.backgroundColor = '#ffec99';
          timerDisplay.style.backgroundColor = '#ffc107';
          timerDisplay.style.color = '#212529';
          break;
        case 'red':
          document.body.style.backgroundColor = '#ff4d4f';
          timerDisplay.style.backgroundColor = '#dc3545';
          timerDisplay.style.color = '#fff';
          break;
        default:
          document.body.style.backgroundColor = '';
          timerDisplay.style.backgroundColor = 'var(--timer-bg)';
          timerDisplay.style.color = 'var(--timer-color)';
      }
    }

    function setGraceIndicator(active) {
      if (!graceIndicator) return;
      if (lastGraceState === active) return;
      lastGraceState = active;
      if (active) {
        graceIndicator.classList.add('active');
        graceIndicator.setAttribute('aria-hidden', 'false');
      } else {
        graceIndicator.classList.remove('active');
        graceIndicator.setAttribute('aria-hidden', 'true');
      }
    }

    function updateBackground() {
      const t = thresholds();
      const graceLimit = t.red > 0 ? t.red + GRACE_SECONDS : null;
      const withinGrace = graceLimit !== null && elapsedSeconds >= t.red && elapsedSeconds <= graceLimit;
      let cue = 'none';

      if (elapsedSeconds >= t.red && t.red > 0) {
        cue = 'red';
      } else if (elapsedSeconds >= t.yellow && t.yellow > 0) {
        cue = 'yellow';
      } else if (elapsedSeconds >= t.green && t.green > 0) {
        cue = 'green';
      }

      applyVisualCue(cue);
      setGraceIndicator(withinGrace);

      if (cue !== 'none' && cue !== lastCue) {
        if (cue === 'red') {
          playDoubleCue();
        } else {
          playCue();
        }
      }

      lastCue = cue;
    }

    function updateTimer() {
      elapsedSeconds += 1;
      timerDisplay.textContent = formatTime(elapsedSeconds);
      updateBackground();
    }

    function evaluateStatus(totalSeconds) {
      const t = thresholds();
      const red = t.red;
      const graceLimit = red > 0 ? red + GRACE_SECONDS : null;

      if (totalSeconds < t.green) {
        return { label: 'Under Time', className: 'status-under', icon: '‚è±Ô∏è' };
      }

      if (red > 0 && totalSeconds > red) {
        if (graceLimit !== null && totalSeconds <= graceLimit) {
          return { label: 'Within Time', className: 'status-within', icon: 'üëç' };
        }
        return { label: 'Over Time', className: 'status-over', icon: 'üëé' };
      }

      return { label: 'Within Time', className: 'status-within', icon: 'üëç' };
    }

    function appendLogRow(rec) {
      const tr = document.createElement('tr');

      const nameCell = document.createElement('td');
      nameCell.textContent = rec.name;
      tr.appendChild(nameCell);

      const topicCell = document.createElement('td');
      topicCell.textContent = rec.topic;
      tr.appendChild(topicCell);

      const timeCell = document.createElement('td');
      timeCell.textContent = rec.totalTime;
      tr.appendChild(timeCell);

      const statusCell = document.createElement('td');
      const wrapper = document.createElement('span');
      wrapper.className = `within-cell ${rec.statusClass}`;
      wrapper.innerHTML = `<span class="status-icon" aria-hidden="true">${rec.statusIcon}</span><span>${rec.statusLabel}</span>`;
      wrapper.setAttribute('role', 'text');
      statusCell.appendChild(wrapper);
      tr.appendChild(statusCell);

      logBody.appendChild(tr);
    }

    function csvEscape(val) {
      const s = String(val ?? '');
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }

    function buildCsv() {
      const header = ['Name', 'Topic', 'TotalTime', 'TimeStatus'];
      const lines = [header.join(',')];
      for (const record of logRecords) {
        lines.push([
          csvEscape(record.name),
          csvEscape(record.topic),
          csvEscape(record.totalTime),
          csvEscape(record.status)
        ].join(','));
      }
      return lines.join('\n');
    }

    function toggleStartPause() {
      if (!isRunning) {
        isRunning = true;
        if (startPauseLabel) startPauseLabel.textContent = 'Pause';
        if (elapsedSeconds === 0) {
          applyVisualCue('none');
          lastCue = 'none';
          setGraceIndicator(false);
        }
        setMetaLocked(true);
        setMetaHidden(true);
        setControlsHidden(true);
        setDisplayHidden(false);
        setRunningHint(true);
        setMiniControlBar(true);
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        isRunning = false;
        if (startPauseLabel) startPauseLabel.textContent = 'Resume';
        clearInterval(timerInterval);
        timerInterval = null;
        setMetaHidden(false);
        setControlsHidden(false);
        setDisplayHidden(true);
        setRunningHint(false);
        setMiniControlBar(false);
      }
    }

    startPauseBtn.addEventListener('click', toggleStartPause);

    resetBtn.addEventListener('click', () => {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      isRunning = false;
      elapsedSeconds = 0;
      timerDisplay.textContent = '00:00';
      applyVisualCue('none');
      lastCue = 'none';
      setGraceIndicator(false);
      if (startPauseLabel) startPauseLabel.textContent = 'Start';
      setMetaLocked(false);
      setMetaHidden(false);
      setControlsHidden(false);
      setDisplayHidden(true);
      setRunningHint(false);
      setMiniControlBar(false);
      speakerInput.value = '';
      topicInput.value = '';
      updateSpeaker();
      updateTopic();
    });

    endTalkBtn.addEventListener('click', async () => {
      const name = (speakerInput.value.trim() || speakerName.textContent || '').trim();
      const topic = (topicInput.value.trim() || topicName.textContent || '').trim();
      const totalTime = formatTime(elapsedSeconds);
      const status = evaluateStatus(elapsedSeconds);

      const record = { id: generateSpeakerId(), name, topic, totalTime, status: status.label };
      logRecords.push(record);
      updateLogVisibility();
      appendLogRow({ ...record, statusLabel: status.label, statusClass: status.className, statusIcon: status.icon });
      await persistRatingsSnapshot();

      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      isRunning = false;
      elapsedSeconds = 0;
      timerDisplay.textContent = '00:00';
      applyVisualCue('none');
      lastCue = 'none';
      setGraceIndicator(false);
      if (startPauseLabel) startPauseLabel.textContent = 'Start';
      setMetaLocked(false);
      setMetaHidden(false);
      setControlsHidden(false);
      setDisplayHidden(true);
      setRunningHint(false);
      setMiniControlBar(false);
      speakerInput.value = '';
      topicInput.value = '';
      updateSpeaker();
      updateTopic();
      document.getElementById('log-section')?.scrollIntoView({ behavior: 'smooth' });
    });

    downloadCsvBtn.addEventListener('click', () => {
      const csv = buildCsv();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement('a');
      const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
      anchor.href = url;
      anchor.download = `toastmasters_log_${timestamp}.csv`;
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
      URL.revokeObjectURL(url);
    });

    ratingsDashboardBtn?.addEventListener('click', async () => {
      const snapshot = await persistRatingsSnapshot();
      const dashboardUrl = new URL('ratings-dashboard.html', window.location.href);
      dashboardUrl.searchParams.set('session', snapshot.sessionId);
      window.open(dashboardUrl.toString(), '_blank', 'noopener');
    });

    document.addEventListener('keydown', (event) => {
      const tag = document.activeElement?.tagName;
      const isFormField = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

      if (event.code === 'Space' && !isFormField) {
        event.preventDefault();
        toggleStartPause();
      }

      if (event.code === 'KeyB' && !event.repeat && !isFormField) {
        event.preventDefault();
        playCue();
      }
    });

    function updateSpeaker() {
      const value = speakerInput.value.trim();
      speakerName.textContent = value ? value : '‚Äî';
    }

    function updateTopic() {
      const value = topicInput.value.trim();
      topicName.textContent = value ? value : '‚Äî';
    }

    speakerInput.addEventListener('input', updateSpeaker);
    topicInput.addEventListener('input', updateTopic);

    testSoundBtn?.addEventListener('click', playCue);

    miniPauseBtn?.addEventListener('click', () => {
      toggleStartPause();
    });

    miniEndTalkBtn?.addEventListener('click', () => {
      if (!confirm('End this talk and log the time?')) {
        return;
      }
      endTalkBtn.click();
    });

    miniDingBtn?.addEventListener('click', () => {
      playCue();
    });

    ensureRatingsSessionId();
    updateRatingsControls();

    updateSpeaker();
    updateTopic();
    applyVisualCue('none');
    setGraceIndicator(false);
    setMetaHidden(false);
    setControlsHidden(false);
    setRunningHint(false);
  </script>

    <footer class="py-3 text-center text-muted small">
      Created by <a href="https://www.linkedin.com/in/tusharvartak/" target="_blank" rel="noopener" class="text-decoration-none fw-semibold">Tushar Vartak</a>
    </footer>

</body>
</html>
